name: Deploy to Production

on:
  push:
    branches:
      - prod

env:
  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        run: |
          cd ${{ env.DEPLOY_PATH }}
          git fetch origin prod
          git reset --hard origin/prod

      - name: Create .env file
        run: |
          cd ${{ env.DEPLOY_PATH }}
          cat > .env << EOF
          # Auto-generated by GitHub Actions
          # $(date)

          # Naver API
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}

          # Gmail SMTP
          GMAIL_ADDRESS=${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}

          # Ollama
          OLLAMA_HOST=http://host.docker.internal:11434
          OLLAMA_MODEL=qwen2.5:7b

          # Database
          DATABASE_URL=sqlite:///./data/healthpulse.db

          # Scheduler (KST 06:00 crawl, 06:10 send)
          CRAWL_HOUR=6
          CRAWL_MINUTE=0
          SEND_HOUR=6
          SEND_MINUTE=10

          # Logging
          LOG_LEVEL=INFO
          EOF

      - name: Build and Deploy
        run: |
          cd ${{ env.DEPLOY_PATH }}

          echo "Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down || true

          echo "Building containers..."
          docker compose -f docker-compose.prod.yml build

          echo "Starting containers..."
          docker compose -f docker-compose.prod.yml up -d

      - name: Health Check
        run: |
          cd ${{ env.DEPLOY_PATH }}
          sleep 15
          echo "Container Status:"
          docker compose -f docker-compose.prod.yml ps
          echo "Deployment completed!"
